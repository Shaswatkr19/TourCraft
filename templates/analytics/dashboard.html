{% extends "base/base.html" %}
{% load static %}
{% block title %}Analytics Dashboard - TourCraft{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css">
<style>
    .analytics-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }
    
    .analytics-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .analytics-header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
    }
    
    .analytics-header p {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
    }
    
    .metric-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        opacity: 0.8;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
    }
    
    .metric-label {
        color: #6c757d;
        font-weight: 500;
    }
    
    .metric-change {
        font-size: 0.9rem;
        margin-top: 10px;
    }
    
    .metric-change.positive {
        color: #28a745;
    }
    
    .metric-change.negative {
        color: #dc3545;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
    }
    
    .chart-controls {
        display: flex;
        gap: 10px;
    }
    
    .chart-btn {
        padding: 8px 16px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    
    .chart-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .chart-btn:hover {
        background: #f8f9fa;
    }
    
    .chart-btn.active:hover {
        background: #0056b3;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .insight-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .insight-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .insight-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }
    
    .insight-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
    }
    
    .insight-content {
        color: #555;
        line-height: 1.6;
    }
    
    .insight-action {
        margin-top: 15px;
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .insight-action:hover {
        background: #0056b3;
        transform: translateY(-2px);
    }
    
    .recent-activity {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .activity-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .activity-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
    }
    
    .activity-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 0;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: white;
    }
    
    .activity-content {
        flex: 1;
    }
    
    .activity-text {
        color: #333;
        margin-bottom: 5px;
    }
    
    .activity-time {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .filters-section {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    
    .filters-header {
        margin-bottom: 20px;
    }
    
    .filters-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }
    
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-label {
        font-weight: 500;
        color: #555;
        margin-bottom: 8px;
    }
    
    .filter-input {
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.9rem;
    }
    
    .filter-select {
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.9rem;
        background: white;
    }
    
    .apply-filters {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
    }
    
    .apply-filters:hover {
        background: #218838;
        transform: translateY(-2px);
    }
    
    @media (max-width: 768px) {
        .analytics-container {
            padding: 15px;
        }
        
        .analytics-header h1 {
            font-size: 2rem;
        }
        
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .metrics-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        .insights-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Header -->
    <div class="analytics-header">
        <h1>Analytics Dashboard</h1>
        <p>Track your tour performance and user engagement</p>
    </div>
    
    <!-- Filters -->
    <div class="filters-section">
        <div class="filters-header">
            <h3 class="filters-title">Filter Data</h3>
        </div>
        <div class="filters-grid">
            <div class="filter-group">
                <label class="filter-label">Date Range</label>
                <select class="filter-select" id="dateRange">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Tour Category</label>
                <select class="filter-select" id="tourCategory">
                    <option value="">All Categories</option>
                    <option value="onboarding">Onboarding</option>
                    <option value="training">Training</option>
                    <option value="demo">Demo</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">User Type</label>
                <select class="filter-select" id="userType">
                    <option value="">All Users</option>
                    <option value="new">New Users</option>
                    <option value="returning">Returning Users</option>
                </select>
            </div>
        </div>
        <button class="apply-filters" onclick="applyFilters()">Apply Filters</button>
    </div>
    
    <!-- Key Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon" style="color: #007bff;">
                <i class="fas fa-eye"></i>
            </div>
            <div class="metric-value" id="totalViews">0</div>
            <div class="metric-label">Total Views</div>
            <div class="metric-change positive" id="viewsChange">+12.5%</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon" style="color: #28a745;">
                <i class="fas fa-users"></i>
            </div>
            <div class="metric-value" id="uniqueUsers">0</div>
            <div class="metric-label">Unique Users</div>
            <div class="metric-change positive" id="usersChange">+8.3%</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon" style="color: #ffc107;">
                <i class="fas fa-clock"></i>
            </div>
            <div class="metric-value" id="avgDuration">0m</div>
            <div class="metric-label">Avg. Duration</div>
            <div class="metric-change negative" id="durationChange">-2.1%</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon" style="color: #dc3545;">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="metric-value" id="completionRate">0%</div>
            <div class="metric-label">Completion Rate</div>
            <div class="metric-change positive" id="completionChange">+5.7%</div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Tour Performance Over Time</h3>
                <div class="chart-controls">
                    <button class="chart-btn active" data-metric="views">Views</button>
                    <button class="chart-btn" data-metric="completions">Completions</button>
                    <button class="chart-btn" data-metric="duration">Duration</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Top Performing Tours</h3>
            </div>
            <div class="chart-container">
                <canvas id="topToursChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Insights -->
    <div class="insights-grid">
        <div class="insight-card">
            <div class="insight-header">
                <div class="insight-icon" style="background: #28a745;">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <h4 class="insight-title">Performance Insight</h4>
            </div>
            <div class="insight-content">
                Your onboarding tour has the highest completion rate (87%) among all tours. Consider using similar patterns for other tours.
            </div>
            <button class="insight-action">View Details</button>
        </div>
        
        <div class="insight-card">
            <div class="insight-header">
                <div class="insight-icon" style="background: #ffc107;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h4 class="insight-title">Attention Required</h4>
            </div>
            <div class="insight-content">
                The training tour has a 23% drop-off rate at step 3. Consider simplifying this step or adding more context.
            </div>
            <button class="insight-action">Optimize Tour</button>
        </div>
        
        <div class="insight-card">
            <div class="insight-header">
                <div class="insight-icon" style="background: #007bff;">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h4 class="insight-title">Growth Opportunity</h4>
            </div>
            <div class="insight-content">
                Mobile users show 15% higher engagement than desktop users. Consider optimizing tours for mobile devices.
            </div>
            <button class="insight-action">Mobile Optimization</button>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="recent-activity">
        <div class="activity-header">
            <h3 class="activity-title">Recent Activity</h3>
        </div>
        <div class="activity-list" id="activityList">
            <!-- Activity items will be populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
class AnalyticsDashboard {
    constructor() {
        this.charts = {};
        this.currentFilters = {
            dateRange: 30,
            tourCategory: '',
            userType: ''
        };
        
        this.init();
    }
    
    init() {
        this.loadMetrics();
        this.initCharts();
        this.loadRecentActivity();
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        // Chart metric toggles
        document.querySelectorAll('.chart-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.updatePerformanceChart(e.target.dataset.metric);
            });
        });
    }
    
    loadMetrics() {
        // Simulate loading metrics from API
        const metrics = {
            totalViews: 15420,
            uniqueUsers: 3247,
            avgDuration: 4.2,
            completionRate: 78.5
        };
        
        document.getElementById('totalViews').textContent = metrics.totalViews.toLocaleString();
        document.getElementById('uniqueUsers').textContent = metrics.uniqueUsers.toLocaleString();
        document.getElementById('avgDuration').textContent = metrics.avgDuration + 'm';
        document.getElementById('completionRate').textContent = metrics.completionRate + '%';
    }
    
    initCharts() {
        this.initPerformanceChart();
        this.initTopToursChart();
    }
    
    initPerformanceChart() {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        
        const data = this.generatePerformanceData('views');
        
        this.charts.performance = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                }
            }
        });
    }
    
    initTopToursChart() {
        const ctx = document.getElementById('topToursChart').getContext('2d');
        
        this.charts.topTours = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Onboarding', 'Training', 'Demo', 'Support'],
                datasets: [{
                    data: [35, 25, 20, 20],
                    backgroundColor: [
                        '#007bff',
                        '#28a745',
                        '#ffc107',
                        '#dc3545'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    generatePerformanceData(metric) {
        const days = 30;
        const labels = [];
        const data = [];
        
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            
            // Generate realistic data
            let value;
            switch(metric) {
                case 'views':
                    value = Math.floor(Math.random() * 100) + 200;
                    break;
                case 'completions':
                    value = Math.floor(Math.random() * 50) + 100;
                    break;
                case 'duration':
                    value = Math.random() * 3 + 2;
                    break;
                default:
                    value = Math.floor(Math.random() * 100) + 200;
            }
            data.push(value);
        }
        
        return {
            labels: labels,
            datasets: [{
                label: metric.charAt(0).toUpperCase() + metric.slice(1),
                data: data,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
            }]
        };
    }
    
    updatePerformanceChart(metric) {
        const data = this.generatePerformanceData(metric);
        this.charts.performance.data = data;
        this.charts.performance.update();
    }
    
    loadRecentActivity() {
        const activities = [
            {
                icon: 'fas fa-play',
                color: '#28a745',
                text: 'User completed "Product Onboarding" tour',
                time: '2 minutes ago'
            },
            {
                icon: 'fas fa-eye',
                color: '#007bff',
                text: 'New user started "Training Module" tour',
                time: '5 minutes ago'
            },
            {
                icon: 'fas fa-share',
                color: '#ffc107',
                text: 'Tour "Demo Walkthrough" was shared',
                time: '12 minutes ago'
            },
            {
                icon: 'fas fa-clock',
                color: '#6c757d',
                text: 'User paused "Support Guide" tour',
                time: '18 minutes ago'
            },
            {
                icon: 'fas fa-check',
                color: '#28a745',
                text: 'Tour "Feature Overview" completed by 5 users',
                time: '25 minutes ago'
            }
        ];
        
        const activityList = document.getElementById('activityList');
        activityList.innerHTML = '';
        
        activities.forEach(activity => {
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            
            activityItem.innerHTML = `
                <div class="activity-icon" style="background: ${activity.color};">
                    <i class="${activity.icon}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-text">${activity.text}</div>
                    <div class="activity-time">${activity.time}</div>
                </div>
            `;
            
            activityList.appendChild(activityItem);
        });
    }
    
    applyFilters() {
        // Simulate applying filters
        console.log('Applying filters:', this.currentFilters);
        
        // Here you would typically make an API call to get filtered data
        // For now, we'll just show a loading state
        this.showLoadingState();
        
        // Simulate API delay
        setTimeout(() => {
            this.hideLoadingState();
            this.loadMetrics();
            this.updateCharts();
        }, 1000);
    }
    
    showLoadingState() {
        // Add loading indicators
        document.querySelectorAll('.metric-value').forEach(el => {
            el.textContent = '...';
        });
    }
    
    hideLoadingState() {
        // Remove loading indicators
        this.loadMetrics();
    }
    
    updateCharts() {
        // Update charts with new filtered data
        if (this.charts.performance) {
            this.charts.performance.update();
        }
        if (this.charts.topTours) {
            this.charts.topTours.update();
        }
    }
}

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    window.analyticsDashboard = new AnalyticsDashboard();
});

function applyFilters() {
    if (window.analyticsDashboard) {
        window.analyticsDashboard.currentFilters.dateRange = parseInt(document.getElementById('dateRange').value);
        window.analyticsDashboard.currentFilters.tourCategory = document.getElementById('tourCategory').value;
        window.analyticsDashboard.currentFilters.userType = document.getElementById('userType').value;
        window.analyticsDashboard.applyFilters();
    }
}
</script>
{% endblock %}
